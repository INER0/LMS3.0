{% extends 'base.html' %}

{% block title %}{{ book.title }} - Library Management System{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb text-white-50">
                <li class="breadcrumb-item">
                    <a href="{% url 'library:dashboard' %}" class="text-white-50 text-decoration-none">
                        <i class="fas fa-home me-1"></i>Dashboard
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'library:book_search' %}" class="text-white-50 text-decoration-none">
                        <i class="fas fa-search me-1"></i>Search Books
                    </a>
                </li>
                <li class="breadcrumb-item active text-white">Book Details</li>
            </ol>
        </nav>
    </div>
    <div>
        <a href="{% url 'library:book_search' %}" class="btn btn-glass">
            <i class="fas fa-arrow-left me-1"></i>Back to Search
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row g-4">
    <!-- Main Book Information -->
    <div class="col-lg-8">
        <div class="glass-card p-4 mb-4">
            <!-- Book Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div>
                    <h1 class="text-white mb-2">{{ book.title }}</h1>
                    <div class="mb-3">
                        {% for author in book.authors.all %}
                            <span class="badge badge-glass me-1">
                                <i class="fas fa-user me-1"></i>{{ author.name }}
                            </span>
                        {% empty %}
                            <span class="badge badge-glass">
                                <i class="fas fa-user me-1"></i>Unknown Author
                            </span>
                        {% endfor %}
                    </div>
                </div>
                <div class="text-end">
                    <span class="badge {% if book.get_available_copies_count > 0 %}bg-success{% else %}bg-danger{% endif %} fs-6">
                        {% if book.get_available_copies_count > 0 %}
                            <i class="fas fa-check-circle me-1"></i>Available ({{ book.get_available_copies_count }})
                        {% else %}
                            <i class="fas fa-times-circle me-1"></i>Not Available
                        {% endif %}
                    </span>
                </div>
            </div>

            <!-- Book Details Grid -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-barcode text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">ISBN:</strong><br>
                            <span class="text-white-50">{{ book.isbn }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-tag text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">Category:</strong><br>
                            <span class="text-white-50">{{ book.get_category_display }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-calendar text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">Publication Year:</strong><br>
                            <span class="text-white-50">{{ book.publication_year }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-language text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">Language:</strong><br>
                            <span class="text-white-50">{{ book.get_language_display }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-industry text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">Publisher:</strong><br>
                            <span class="text-white-50">{{ book.publisher.name }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-edit text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">Edition:</strong><br>
                            <span class="text-white-50">{{ book.edition }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-building text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">Location:</strong><br>
                            <span class="text-white-50">{{ book.section.branch.name }} - {{ book.section.name }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-copy text-white-50 me-3"></i>
                        <div>
                            <strong class="text-white">Total Copies:</strong><br>
                            <span class="text-white-50">{{ book.get_total_copies_count }} copies</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            {% if user.is_authenticated %}
                <div class="d-flex gap-3 flex-wrap">
                    {% if book.get_available_copies_count > 0 %}
                        <a href="{% url 'circulation:borrow' book.id %}" class="btn btn-success">
                            <i class="fas fa-book me-2"></i>Borrow This Book
                        </a>
                    {% else %}
                        <a href="{% url 'circulation:reserve' book.id %}" class="btn btn-warning">
                            <i class="fas fa-bookmark me-2"></i>Reserve This Book
                        </a>
                    {% endif %}
                    
                    <button type="button" class="btn btn-glass" data-bs-toggle="modal" data-bs-target="#shareModal">
                        <i class="fas fa-share me-2"></i>Share Book
                    </button>
                    
                    <button type="button" class="btn btn-glass" onclick="printBookDetails()">
                        <i class="fas fa-print me-2"></i>Print Details
                    </button>
                </div>
            {% else %}
                <div class="alert alert-glass border-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    Please <a href="{% url 'authentication:login' %}" class="text-white fw-bold text-decoration-underline">login</a> 
                    to borrow or reserve this book.
                </div>
            {% endif %}
        </div>

        <!-- Book Copies -->
        {% if copies %}
        <div class="glass-card p-4 mb-4">
            <h4 class="text-white mb-4">
                <i class="fas fa-copy me-2"></i>Available Copies
            </h4>
            <div class="table-responsive">
                <table class="table table-glass">
                    <thead>
                        <tr>
                            <th>Barcode</th>
                            <th>Condition</th>
                            <th>Status</th>
                            <th>Last Seen</th>
                            {% if user.is_authenticated %}
                            <th>Action</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for copy in copies %}
                        <tr>
                            <td>{{ copy.barcode }}</td>
                            <td>
                                <span class="badge {% if copy.condition == 'good' %}bg-success{% elif copy.condition == 'damaged' %}bg-warning{% else %}bg-danger{% endif %}">
                                    {{ copy.get_condition_display }}
                                </span>
                            </td>
                            <td>
                                {% if copy.is_available %}
                                    <span class="badge bg-success">Available</span>
                                {% else %}
                                    <span class="badge bg-danger">Borrowed</span>
                                {% endif %}
                            </td>
                            <td>{{ copy.last_seen|date:"M j, Y" }}</td>
                            {% if user.is_authenticated %}
                            <td>
                                {% if copy.is_available and copy.condition == 'good' %}
                                    <a href="{% url 'circulation:borrow_copy' copy.id %}" class="btn btn-success btn-sm">
                                        <i class="fas fa-book me-1"></i>Borrow
                                    </a>
                                {% else %}
                                    <button class="btn btn-secondary btn-sm" disabled>
                                        <i class="fas fa-times me-1"></i>Unavailable
                                    </button>
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Stats -->
        <div class="glass-card p-4 mb-4">
            <h5 class="text-white mb-3">
                <i class="fas fa-chart-bar me-2"></i>Book Statistics
            </h5>
            <div class="row g-3 text-center">
                <div class="col-6">
                    <div class="p-3 rounded" style="background: rgba(40, 167, 69, 0.1);">
                        <i class="fas fa-check-circle text-success display-6"></i>
                        <h4 class="text-white mt-2">{{ book.get_available_copies_count }}</h4>
                        <small class="text-white-50">Available</small>
                    </div>
                </div>
                <div class="col-6">
                    <div class="p-3 rounded" style="background: rgba(220, 53, 69, 0.1);">
                        <i class="fas fa-book text-danger display-6"></i>
                        <h4 class="text-white mt-2">{{ book.borrowed_count|default:0 }}</h4>
                        <small class="text-white-50">Borrowed</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Similar Books -->
        {% if similar_books %}
        <div class="glass-card p-4 mb-4">
            <h5 class="text-white mb-3">
                <i class="fas fa-books me-2"></i>Similar Books
            </h5>
            {% for similar_book in similar_books %}
                <div class="d-flex align-items-start mb-3 pb-3 border-bottom border-secondary">
                    <div class="flex-grow-1">
                        <h6 class="text-white mb-1">
                            <a href="{% url 'library:book_detail' similar_book.id %}" class="text-white text-decoration-none">
                                {{ similar_book.title|truncatechars:40 }}
                            </a>
                        </h6>
                        <p class="text-white-50 mb-1 small">{{ similar_book.authors.all.0.name|default:"Unknown Author" }}</p>
                        <small class="text-white-50">{{ similar_book.publication_year }}</small>
                    </div>
                    <span class="badge {% if similar_book.get_available_copies_count > 0 %}bg-success{% else %}bg-danger{% endif %} ms-2">
                        {% if similar_book.get_available_copies_count > 0 %}Available{% else %}Borrowed{% endif %}
                    </span>
                </div>
            {% endfor %}
            <a href="{% url 'library:book_search' %}?category={{ book.category }}" class="btn btn-glass btn-sm">
                <i class="fas fa-search me-1"></i>More in {{ book.get_category_display }}
            </a>
        </div>
        {% endif %}

        <!-- Borrowing Rules -->
        <div class="glass-card p-4">
            <h5 class="text-white mb-3">
                <i class="fas fa-info-circle me-2"></i>Borrowing Rules
            </h5>
            <ul class="list-unstyled text-white-50">
                <li class="mb-2">
                    <i class="fas fa-clock me-2 text-info"></i>
                    Loan period: 14 days
                </li>
                <li class="mb-2">
                    <i class="fas fa-redo me-2 text-warning"></i>
                    Extension: 7 additional days
                </li>
                <li class="mb-2">
                    <i class="fas fa-money-bill me-2 text-danger"></i>
                    Late fee: MVR 2-10 per day
                </li>
                <li class="mb-2">
                    <i class="fas fa-bookmark me-2 text-success"></i>
                    Free reservations available
                </li>
            </ul>
            <a href="{% url 'library:borrowing_rules' %}" class="btn btn-glass btn-sm">
                <i class="fas fa-file-alt me-1"></i>Full Rules
            </a>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2);">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-white">
                    <i class="fas fa-share me-2"></i>Share Book
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-white-50 mb-3">Share this book with friends and colleagues:</p>
                <div class="mb-3">
                    <label class="form-label text-white">Book URL:</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="bookUrl" value="{{ request.build_absolute_uri }}" readonly>
                        <button class="btn btn-glass" type="button" onclick="copyBookUrl()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-center">
                    <a href="mailto:?subject={{ book.title|urlencode }}&body=Check out this book: {{ request.build_absolute_uri|urlencode }}" class="btn btn-glass">
                        <i class="fas fa-envelope me-1"></i>Email
                    </a>
                    <a href="https://twitter.com/intent/tweet?text=Check out this book: {{ book.title|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" target="_blank" class="btn btn-glass">
                        <i class="fab fa-twitter me-1"></i>Twitter
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}" target="_blank" class="btn btn-glass">
                        <i class="fab fa-facebook me-1"></i>Facebook
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function copyBookUrl() {
        const urlInput = document.getElementById('bookUrl');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);
        
        try {
            document.execCommand('copy');
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            btn.classList.add('btn-success');
            
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove('btn-success');
            }, 2000);
        } catch (err) {
            alert('Please manually copy the URL');
        }
    }

    function printBookDetails() {
        const printContent = `
            <html>
                <head>
                    <title>{{ book.title }} - Book Details</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        .details { margin-bottom: 10px; }
                        .label { font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>{{ book.title }}</h1>
                        <p>Library Management System - Book Details</p>
                    </div>
                    <div class="details"><span class="label">Authors:</span> {% for author in book.authors.all %}{{ author.name }}{% if not forloop.last %}, {% endif %}{% endfor %}</div>
                    <div class="details"><span class="label">ISBN:</span> {{ book.isbn }}</div>
                    <div class="details"><span class="label">Category:</span> {{ book.get_category_display }}</div>
                    <div class="details"><span class="label">Publication Year:</span> {{ book.publication_year }}</div>
                    <div class="details"><span class="label">Language:</span> {{ book.get_language_display }}</div>
                    <div class="details"><span class="label">Publisher:</span> {{ book.publisher.name }}</div>
                    <div class="details"><span class="label">Edition:</span> {{ book.edition }}</div>
                    <div class="details"><span class="label">Location:</span> {{ book.section.branch.name }} - {{ book.section.name }}</div>
                    <div class="details"><span class="label">Available Copies:</span> {{ book.get_available_copies_count }}</div>
                    <div class="details"><span class="label">Total Copies:</span> {{ book.get_total_copies_count }}</div>
                    <p style="margin-top: 30px; color: #666; font-size: 12px;">Printed on: ${new Date().toLocaleDateString()}</p>
                </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.print();
        printWindow.close();
    }

    // Book availability checker
    function checkBookAvailability() {
        // This would typically make an AJAX call to check real-time availability
        // For now, we'll just refresh the page
        location.reload();
    }

    // Auto-refresh availability every 30 seconds for popular books
    {% if book.is_popular %}
    setInterval(function() {
        // Visual indicator that we're checking availability
        const availabilityBadge = document.querySelector('.badge');
        if (availabilityBadge) {
            availabilityBadge.style.opacity = '0.5';
            setTimeout(() => {
                availabilityBadge.style.opacity = '1';
            }, 1000);
        }
    }, 30000);
    {% endif %}
</script>
{% endblock %}
