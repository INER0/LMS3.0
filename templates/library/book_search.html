{% extends 'base.html' %}

{% block title %}Search Books - Library Management System{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-white mb-1">
            <i class="fas fa-search me-2"></i>Search Books
        </h1>
        <p class="text-white-50 mb-0">Find your next great read from our collection</p>
    </div>
    <div>
        <span class="badge badge-glass fs-6">
            <i class="fas fa-book me-1"></i>{{ total_books|default:0 }} books available
        </span>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Search Form -->
<div class="glass-card p-4 mb-4">
    <form method="get" action="{% url 'library:book_search' %}">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control" name="q" placeholder="Search by title, author, or ISBN..." 
                           value="{{ request.GET.q }}" autocomplete="off">
                </div>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="category">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                        <option value="{{ category.0 }}" {% if request.GET.category == category.0 %}selected{% endif %}>
                            {{ category.1 }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="language">
                    <option value="">All Languages</option>
                    {% for language in languages %}
                        <option value="{{ language.0 }}" {% if request.GET.language == language.0 %}selected{% endif %}>
                            {{ language.1 }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select" name="branch">
                    <option value="">All Branches</option>
                    {% for branch in branches %}
                        <option value="{{ branch.id }}" {% if request.GET.branch == branch.id|stringformat:"s" %}selected{% endif %}>
                            {{ branch.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-glass w-100">
                    <i class="fas fa-search me-1"></i>Search
                </button>
            </div>
        </div>
        <div class="row g-3 mt-2">
            <div class="col-md-3">
                <select class="form-select" name="availability">
                    <option value="">All Books</option>
                    <option value="available" {% if request.GET.availability == 'available' %}selected{% endif %}>Available Only</option>
                    <option value="borrowed" {% if request.GET.availability == 'borrowed' %}selected{% endif %}>Currently Borrowed</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="sort_by">
                    <option value="title" {% if request.GET.sort_by == 'title' %}selected{% endif %}>Title (A-Z)</option>
                    <option value="-title" {% if request.GET.sort_by == '-title' %}selected{% endif %}>Title (Z-A)</option>
                    <option value="publication_year" {% if request.GET.sort_by == 'publication_year' %}selected{% endif %}>Year (Old-New)</option>
                    <option value="-publication_year" {% if request.GET.sort_by == '-publication_year' %}selected{% endif %}>Year (New-Old)</option>
                    <option value="category" {% if request.GET.sort_by == 'category' %}selected{% endif %}>Category</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" name="per_page">
                    <option value="12" {% if request.GET.per_page == '12' %}selected{% endif %}>12 per page</option>
                    <option value="24" {% if request.GET.per_page == '24' %}selected{% endif %}>24 per page</option>
                    <option value="48" {% if request.GET.per_page == '48' %}selected{% endif %}>48 per page</option>
                </select>
            </div>
            {% if request.GET.q or request.GET.category or request.GET.language or request.GET.branch or request.GET.availability %}
            <div class="col-md-3">
                <a href="{% url 'library:book_search' %}" class="btn btn-outline-light w-100">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </a>
            </div>
            {% endif %}
        </div>
    </form>
</div>

<!-- Search Results -->
{% if query %}
<div class="mb-3">
    <p class="text-white-50">
        Showing {{ books.start_index }}-{{ books.end_index }} of {{ books.paginator.count }} results for 
        <strong class="text-white">"{{ query }}"</strong>
    </p>
</div>
{% endif %}

<!-- Active Filters -->
{% if request.GET.category or request.GET.language or request.GET.branch or request.GET.availability %}
<div class="mb-3">
    <div class="d-flex flex-wrap gap-2">
        <span class="text-white-50 me-2">Active filters:</span>
        {% if request.GET.category %}
            <span class="badge badge-glass">
                Category: {{ request.GET.category|title }}
                <a href="?" class="text-decoration-none ms-1" style="color: inherit;">×</a>
            </span>
        {% endif %}
        {% if request.GET.language %}
            <span class="badge badge-glass">
                Language: {{ request.GET.language|title }}
                <a href="?" class="text-decoration-none ms-1" style="color: inherit;">×</a>
            </span>
        {% endif %}
        {% if request.GET.branch %}
            <span class="badge badge-glass">
                Branch: {{ request.GET.branch }}
                <a href="?" class="text-decoration-none ms-1" style="color: inherit;">×</a>
            </span>
        {% endif %}
        {% if request.GET.availability %}
            <span class="badge badge-glass">
                Availability: {{ request.GET.availability|title }}
                <a href="?" class="text-decoration-none ms-1" style="color: inherit;">×</a>
            </span>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Books Grid -->
{% if books %}
<div class="row g-4 mb-4">
    {% for book in books %}
        <div class="col-md-6 col-lg-4 col-xl-3">
            <div class="card glass-card h-100">
                <div class="card-body text-white d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <span class="badge badge-glass">{{ book.category|title }}</span>
                        <span class="badge {% if book.get_available_copies_count > 0 %}bg-success{% else %}bg-danger{% endif %}">
                            {% if book.get_available_copies_count > 0 %}
                                Available ({{ book.get_available_copies_count }})
                            {% else %}
                                Not Available
                            {% endif %}
                        </span>
                    </div>
                    
                    <h6 class="card-title mb-2">{{ book.title|truncatechars:60 }}</h6>
                    
                    <div class="mb-2">
                        <strong class="text-white-50">Authors:</strong><br>
                        {% for author in book.authors.all %}
                            <span class="text-white">{{ author.name }}</span>{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            <span class="text-white-50">Unknown Author</span>
                        {% endfor %}
                    </div>
                    
                    <div class="row text-center mb-3 text-white-50 small">
                        <div class="col-4">
                            <i class="fas fa-calendar me-1"></i>
                            {{ book.publication_year }}
                        </div>
                        <div class="col-4">
                            <i class="fas fa-language me-1"></i>
                            {{ book.get_language_display }}
                        </div>
                        <div class="col-4">
                            <i class="fas fa-barcode me-1"></i>
                            {{ book.isbn }}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <small class="text-white-50">
                            <i class="fas fa-building me-1"></i>{{ book.section.branch.name }} - {{ book.section.name }}
                        </small>
                        <br>
                        <small class="text-white-50">
                            <i class="fas fa-industry me-1"></i>{{ book.publisher.name }}
                        </small>
                    </div>
                    
                    <div class="mt-auto d-flex gap-2">
                        <a href="{% url 'library:book_detail' book.id %}" class="btn btn-glass btn-sm flex-fill">
                            <i class="fas fa-eye me-1"></i>Details
                        </a>
                        {% if user.is_authenticated %}
                            {% if book.get_available_copies_count > 0 %}
                                <a href="{% url 'circulation:borrow' book.id %}" class="btn btn-glass btn-sm flex-fill">
                                    <i class="fas fa-book me-1"></i>Borrow
                                </a>
                            {% else %}
                                <a href="{% url 'circulation:reserve' book.id %}" class="btn btn-glass btn-sm flex-fill">
                                    <i class="fas fa-bookmark me-1"></i>Reserve
                                </a>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if books.has_other_pages %}
<div class="glass-card p-3">
    <nav aria-label="Book search pagination">
        <ul class="pagination mb-0 justify-content-center">
            {% if books.has_previous %}
                <li class="page-item">
                    <a class="page-link text-white" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);">
                        <i class="fas fa-angle-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link text-white" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ books.previous_page_number }}" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);">
                        <i class="fas fa-angle-left"></i>
                    </a>
                </li>
            {% endif %}
            
            {% for num in books.paginator.page_range %}
                {% if num == books.number %}
                    <li class="page-item active">
                        <span class="page-link text-white" style="background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.4);">{{ num }}</span>
                    </li>
                {% elif num > books.number|add:'-3' and num < books.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link text-white" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);">{{ num }}</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if books.has_next %}
                <li class="page-item">
                    <a class="page-link text-white" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ books.next_page_number }}" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);">
                        <i class="fas fa-angle-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link text-white" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ books.paginator.num_pages }}" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2);">
                        <i class="fas fa-angle-double-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endif %}

{% else %}
<div class="glass-card p-5">
    <div class="text-center">
        <i class="fas fa-search display-1 text-white-50 mb-4"></i>
        <h3 class="text-white mb-3">No books found</h3>
        {% if query %}
            <p class="text-white-50 mb-4">
                No books match your search criteria. Try adjusting your filters or search terms.
            </p>
        {% else %}
            <p class="text-white-50 mb-4">
                Enter search terms above to find books in our collection.
            </p>
        {% endif %}
        <div class="d-flex justify-content-center gap-2">
            <a href="{% url 'library:book_search' %}" class="btn btn-glass">
                <i class="fas fa-refresh me-1"></i>Clear Search
            </a>
            <a href="{% url 'library:dashboard' %}" class="btn btn-glass">
                <i class="fas fa-home me-1"></i>Back to Dashboard
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Search Tips -->
<div class="glass-card p-4 mt-4">
    <h5 class="text-white mb-3">
        <i class="fas fa-lightbulb me-2"></i>Search Tips
    </h5>
    <div class="row g-3 text-white-50">
        <div class="col-md-6">
            <ul class="list-unstyled">
                <li><i class="fas fa-check me-2 text-success"></i>Use specific keywords for better results</li>
                <li><i class="fas fa-check me-2 text-success"></i>Try searching by author's full name</li>
                <li><i class="fas fa-check me-2 text-success"></i>Use ISBN for exact book matches</li>
            </ul>
        </div>
        <div class="col-md-6">
            <ul class="list-unstyled">
                <li><i class="fas fa-check me-2 text-success"></i>Filter by category to narrow results</li>
                <li><i class="fas fa-check me-2 text-success"></i>Sort by publication year for latest books</li>
                <li><i class="fas fa-check me-2 text-success"></i>Check availability before visiting library</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-submit form when filters change
    document.querySelectorAll('select[name="category"], select[name="language"], select[name="branch"], select[name="availability"], select[name="sort_by"], select[name="per_page"]').forEach(function(select) {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });

    // Search input enhancement
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                this.form.submit();
            }
        });
    }

    // Highlight search terms
    const query = "{{ query|escapejs }}";
    if (query) {
        const regex = new RegExp(`(${query})`, 'gi');
        document.querySelectorAll('.card-title, .card-text').forEach(function(element) {
            element.innerHTML = element.innerHTML.replace(regex, '<mark style="background: rgba(255,255,0,0.3); color: white;">$1</mark>');
        });
    }
</script>
{% endblock %}
