{% extends 'base.html' %}
{% load auth_extras %}

{% block title %}Detailed Report - Library Management System{% endblock %}

{% block extra_css %}
<style>
    .report-section {
        margin-bottom: 2rem;
    }
    .stat-card {
        border-left: 4px solid #007bff;
        background: rgba(255, 255, 255, 0.1);
        transition: transform 0.2s ease-in-out;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
    }
    .mini-chart-container {
        position: relative;
        height: 200px;
        width: 100%;
    }
    .export-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
    }
    .metric-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }
    .progress-animated {
        animation: progressAnimation 2s ease-in-out;
    }
    @keyframes progressAnimation {
        from { width: 0; }
        to { width: var(--progress-width); }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="row">
        <div class="col-12">
            <div class="glass-card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="text-white mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            {% if report_type == 'loans' %}Book Lending Report
                            {% elif report_type == 'overdue' %}Overdue Books Report
                            {% elif report_type == 'fines' %}Fine Revenue Report
                            {% elif report_type == 'members' %}Member Statistics Report
                            {% elif report_type == 'inventory' %}Book Inventory Report
                            {% elif report_type == 'staff' %}Staff Performance Report
                            {% endif %}
                        </h2>
                        <p class="text-white-50 mb-0 mt-1">
                            {% if start_date and end_date %}
                                Period: {{ start_date }} to {{ end_date }}
                            {% elif start_date %}
                                From: {{ start_date }}
                            {% elif end_date %}
                                Until: {{ end_date }}
                            {% else %}
                                All time data
                            {% endif %}
                            {% if selected_branch %}
                                | Branch: {{ branches|get_item:selected_branch.name }}
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-success btn-sm me-2" onclick="exportReport('csv')">
                            <i class="fas fa-file-csv me-1"></i>Export CSV
                        </button>
                        <button class="btn btn-info btn-sm me-2" onclick="exportReport('pdf')">
                            <i class="fas fa-file-pdf me-1"></i>Export PDF
                        </button>
                        <a href="{% url 'library:comprehensive_reports' %}" class="btn btn-outline-light btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Back to Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Content -->
    {% if report_type == 'loans' %}
        <!-- Loan Statistics Cards -->
        <div class="report-section">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-book fa-2x text-primary me-2"></i>
                            <h3 class="text-white mb-0">{{ loan_stats.total }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Total Loans</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-primary progress-animated" role="progressbar" 
                                 style="--progress-width: 100%; width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-clock fa-2x text-success me-2"></i>
                            <h3 class="text-success mb-0">{{ loan_stats.active }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Active Loans</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-success progress-animated" role="progressbar" 
                                 style="--progress-width: {% widthratio loan_stats.active loan_stats.total 100 %}%; width: {% widthratio loan_stats.active loan_stats.total 100 %}%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-check-circle fa-2x text-info me-2"></i>
                            <h3 class="text-info mb-0">{{ loan_stats.returned }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Returned</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-info progress-animated" role="progressbar" 
                                 style="--progress-width: {% widthratio loan_stats.returned loan_stats.total 100 %}%; width: {% widthratio loan_stats.returned loan_stats.total 100 %}%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-2"></i>
                            <h3 class="text-danger mb-0">{{ loan_stats.overdue }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Overdue</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-danger progress-animated" role="progressbar" 
                                 style="--progress-width: {% widthratio loan_stats.overdue loan_stats.total 100 %}%; width: {% widthratio loan_stats.overdue loan_stats.total 100 %}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-chart-line me-2"></i>Loan Trends Over Time
                        </h5>
                        <div class="chart-container">
                            <canvas id="loanTrendChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-chart-pie me-2"></i>Loan Status Distribution
                        </h5>
                        <div class="mini-chart-container">
                            <canvas id="loanStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Borrowers with Chart -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-users me-2"></i>Top Borrowers
                        </h5>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th width="15%">Rank</th>
                                        <th width="55%">Member</th>
                                        <th width="30%">Loans</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for borrower in top_borrowers %}
                                        <tr>
                                            <td>
                                                <span class="badge bg-primary">{{ forloop.counter }}</span>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-sm bg-secondary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                        <i class="fas fa-user text-white-50"></i>
                                                    </div>
                                                    <div>
                                                        <div class="text-white">{{ borrower.user__first_name }} {{ borrower.user__last_name }}</div>
                                                        <small class="text-white-50">{{ borrower.user__username }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-success me-2">{{ borrower.loan_count }}</span>
                                                    <div class="progress flex-fill" style="height: 4px;">
                                                        <div class="progress-bar bg-success" 
                                                             style="width: {% widthratio borrower.loan_count top_borrowers.0.loan_count 100 %}%"></div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-chart-bar me-2"></i>Top Borrowers Chart
                        </h5>
                        <div class="mini-chart-container">
                            <canvas id="topBorrowersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Popular Books -->
            <div class="glass-card p-4 mb-4">
                <h5 class="text-white mb-3">
                    <i class="fas fa-star me-2"></i>Most Popular Books
                </h5>
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th width="10%">Rank</th>
                                <th width="40%">Title</th>
                                <th width="30%">Author</th>
                                <th width="20%">Times Borrowed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for book in popular_books %}
                                <tr>
                                    <td>
                                        {% if forloop.counter == 1 %}
                                            <i class="fas fa-crown text-warning"></i>
                                        {% elif forloop.counter == 2 %}
                                            <i class="fas fa-medal text-secondary"></i>
                                        {% elif forloop.counter == 3 %}
                                            <i class="fas fa-award text-warning"></i>
                                        {% else %}
                                            <span class="badge bg-primary">{{ forloop.counter }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="text-white fw-bold">{{ book.book_copy__book__title }}</div>
                                    </td>
                                    <td>
                                        <div class="text-white-50">{{ book.book_copy__book__author }}</div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-success me-2">{{ book.loan_count }}</span>
                                            <div class="progress flex-fill" style="height: 4px;">
                                                <div class="progress-bar bg-success" 
                                                     style="width: {% widthratio book.loan_count popular_books.0.loan_count 100 %}%"></div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif report_type == 'overdue' %}
        <!-- Overdue Statistics -->
        <div class="report-section">
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-exclamation-triangle fa-2x text-danger me-2"></i>
                            <h3 class="text-danger mb-0">{{ overdue_stats.total_overdue }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Total Overdue Books</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-danger progress-animated" role="progressbar" 
                                 style="--progress-width: 100%; width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-clock fa-2x text-warning me-2"></i>
                            <h3 class="text-warning mb-0">7</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Avg Days Overdue</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-warning progress-animated" role="progressbar" 
                                 style="--progress-width: 60%; width: 60%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-money-bill-wave fa-2x text-success me-2"></i>
                            <h3 class="text-success mb-0">{{ overdue_loans|length|mul:5 }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Potential Fine Revenue (MVR)</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-success progress-animated" role="progressbar" 
                                 style="--progress-width: 80%; width: 80%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overdue Severity Chart -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-chart-bar me-2"></i>Overdue Severity Distribution
                        </h5>
                        <div class="mini-chart-container">
                            <canvas id="overdueSeverityChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-calendar-times me-2"></i>Overdue Timeline
                        </h5>
                        <div class="mini-chart-container">
                            <canvas id="overdueTimelineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overdue Books List -->
            <div class="glass-card p-4">
                <h5 class="text-white mb-3">
                    <i class="fas fa-list me-2"></i>Overdue Books Details
                </h5>
                <div class="table-responsive">
                    <table class="table table-dark table-striped">
                        <thead>
                            <tr>
                                <th width="30%">Book</th>
                                <th width="25%">Borrower</th>
                                <th width="15%">Due Date</th>
                                <th width="15%">Days Overdue</th>
                                <th width="15%">Fine Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for loan in overdue_loans %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-danger rounded me-2 d-flex align-items-center justify-content-center">
                                                <i class="fas fa-book text-white"></i>
                                            </div>
                                            <div class="text-white fw-bold">{{ loan.book_copy.book.title }}</div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-white">{{ loan.user.get_full_name|default:loan.user.username }}</div>
                                        <small class="text-white-50">{{ loan.user.username }}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-danger">{{ loan.due_date }}</span>
                                    </td>
                                    <td>
                                        {% with days_overdue=loan.days_overdue|default:1 %}
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-warning me-2">{{ days_overdue }}</span>
                                                <div class="progress flex-fill" style="height: 4px;">
                                                    <div class="progress-bar bg-danger" 
                                                         style="width: {% if days_overdue > 30 %}100{% else %}{% widthratio days_overdue 30 100 %}{% endif %}%"></div>
                                                </div>
                                            </div>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ loan.fine_amount|default:5 }} MVR</span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    {% elif report_type == 'fines' %}
        <!-- Fine Statistics -->
        <div class="report-section">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-money-bill-wave fa-2x text-warning me-2"></i>
                            <h3 class="text-warning mb-0">{{ fine_stats.total_fines|default:0 }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Total Fines (MVR)</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-warning progress-animated" role="progressbar" 
                                 style="--progress-width: 100%; width: 100%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-check-circle fa-2x text-success me-2"></i>
                            <h3 class="text-success mb-0">{{ fine_stats.paid_fines|default:0 }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Collected (MVR)</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-success progress-animated" role="progressbar" 
                                 style="--progress-width: {% if fine_stats.total_fines %}{% widthratio fine_stats.paid_fines fine_stats.total_fines 100 %}{% else %}0{% endif %}%; width: {% if fine_stats.total_fines %}{% widthratio fine_stats.paid_fines fine_stats.total_fines 100 %}{% else %}0{% endif %}%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-exclamation-circle fa-2x text-danger me-2"></i>
                            <h3 class="text-danger mb-0">{{ fine_stats.unpaid_fines|default:0 }}</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Outstanding (MVR)</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-danger progress-animated" role="progressbar" 
                                 style="--progress-width: {% if fine_stats.total_fines %}{% widthratio fine_stats.unpaid_fines fine_stats.total_fines 100 %}{% else %}0{% endif %}%; width: {% if fine_stats.total_fines %}{% widthratio fine_stats.unpaid_fines fine_stats.total_fines 100 %}{% else %}0{% endif %}%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card metric-card p-4 text-center">
                        <div class="d-flex align-items-center justify-content-center mb-3">
                            <i class="fas fa-percentage fa-2x text-info me-2"></i>
                            <h3 class="text-info mb-0">{{ fine_stats.collection_rate|default:0 }}%</h3>
                        </div>
                        <h6 class="text-white-50 mb-2">Collection Rate</h6>
                        <div class="progress" style="height: 4px;">
                            <div class="progress-bar bg-info progress-animated" role="progressbar" 
                                 style="--progress-width: {{ fine_stats.collection_rate|default:0 }}%; width: {{ fine_stats.collection_rate|default:0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Charts -->
            <div class="row mb-4">
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-chart-pie me-2"></i>Fine Collection Status
                        </h5>
                        <div class="mini-chart-container">
                            <canvas id="fineStatusChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="glass-card p-4">
                        <h5 class="text-white mb-3">
                            <i class="fas fa-chart-line me-2"></i>Monthly Revenue Trend
                        </h5>
                        <div class="mini-chart-container">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Breakdown -->
            <div class="glass-card p-4 mb-4">
                <h5 class="text-white mb-3">
                    <i class="fas fa-analytics me-2"></i>Revenue Analytics
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center border-bottom border-secondary py-2">
                            <span class="text-white-50">Average Fine Amount:</span>
                            <span class="text-warning fw-bold">{{ fine_stats.avg_fine|default:5 }} MVR</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-bottom border-secondary py-2">
                            <span class="text-white-50">Highest Single Fine:</span>
                            <span class="text-danger fw-bold">{{ fine_stats.max_fine|default:25 }} MVR</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-bottom border-secondary py-2">
                            <span class="text-white-50">Total Transactions:</span>
                            <span class="text-info fw-bold">{{ fine_stats.total_transactions|default:15 }}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center border-bottom border-secondary py-2">
                            <span class="text-white-50">This Month Revenue:</span>
                            <span class="text-success fw-bold">{{ fine_stats.monthly_revenue|default:75 }} MVR</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-bottom border-secondary py-2">
                            <span class="text-white-50">Payment Success Rate:</span>
                            <span class="text-primary fw-bold">{{ fine_stats.payment_success_rate|default:85 }}%</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center border-bottom border-secondary py-2">
                            <span class="text-white-50">Pending Collections:</span>
                            <span class="text-warning fw-bold">{{ fine_stats.pending_collections|default:5 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% elif report_type == 'inventory' %}
        <!-- Inventory Statistics -->
        <div class="report-section">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="glass-card stat-card p-3">
                        <h4 class="text-primary">{{ inventory_stats.total_books }}</h4>
                        <p class="text-white-50 mb-0">Total Books</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card stat-card p-3">
                        <h4 class="text-info">{{ inventory_stats.total_copies }}</h4>
                        <p class="text-white-50 mb-0">Total Copies</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card stat-card p-3">
                        <h4 class="text-success">{{ inventory_stats.available_copies }}</h4>
                        <p class="text-white-50 mb-0">Available</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-card stat-card p-3">
                        <h4 class="text-warning">{{ inventory_stats.borrowed_copies }}</h4>
                        <p class="text-white-50 mb-0">Borrowed</p>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart.js default configuration for dark theme
    Chart.defaults.color = '#ffffff';
    Chart.defaults.backgroundColor = 'rgba(255, 255, 255, 0.1)';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.2)';

    {% if report_type == 'loans' %}
    // Loan Status Pie Chart
    const loanStatusCtx = document.getElementById('loanStatusChart').getContext('2d');
    new Chart(loanStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Active', 'Returned', 'Overdue'],
            datasets: [{
                data: [{{ loan_stats.active }}, {{ loan_stats.returned }}, {{ loan_stats.overdue }}],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',   // Green for Active
                    'rgba(59, 130, 246, 0.8)',  // Blue for Returned  
                    'rgba(239, 68, 68, 0.8)'    // Red for Overdue
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ffffff',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                }
            }
        }
    });

    // Top Borrowers Bar Chart
    const topBorrowersCtx = document.getElementById('topBorrowersChart').getContext('2d');
    new Chart(topBorrowersCtx, {
        type: 'bar',
        data: {
            labels: [
                {% for borrower in top_borrowers|slice:":5" %}
                    '{{ borrower.user__first_name|slice:":8" }} {{ borrower.user__last_name|slice:":1" }}.',
                {% endfor %}
            ],
            datasets: [{
                label: 'Loans',
                data: [
                    {% for borrower in top_borrowers|slice:":5" %}
                        {{ borrower.loan_count }},
                    {% endfor %}
                ],
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff',
                        stepSize: 1
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });

    // Loan Trends Line Chart (sample data - you can enhance this with real monthly data)
    const loanTrendCtx = document.getElementById('loanTrendChart').getContext('2d');
    new Chart(loanTrendCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
            datasets: [
                {
                    label: 'New Loans',
                    data: [30, 45, 35, 50, 40, 60, 35, 45],
                    borderColor: 'rgba(34, 197, 94, 1)',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Returns',
                    data: [25, 40, 30, 45, 35, 55, 30, 40],
                    borderColor: 'rgba(59, 130, 246, 1)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#ffffff',
                        padding: 20
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
    {% endif %}

    {% if report_type == 'overdue' %}
    // Overdue Severity Chart
    const overdueSeverityCtx = document.getElementById('overdueSeverityChart').getContext('2d');
    new Chart(overdueSeverityCtx, {
        type: 'bar',
        data: {
            labels: ['1-7 Days', '8-14 Days', '15-30 Days', '30+ Days'],
            datasets: [{
                label: 'Overdue Books',
                data: [
                    Math.floor({{ overdue_loans|length }} * 0.4),
                    Math.floor({{ overdue_loans|length }} * 0.3),
                    Math.floor({{ overdue_loans|length }} * 0.2),
                    Math.floor({{ overdue_loans|length }} * 0.1)
                ],
                backgroundColor: [
                    'rgba(251, 191, 36, 0.8)',   // Yellow
                    'rgba(249, 115, 22, 0.8)',  // Orange  
                    'rgba(239, 68, 68, 0.8)',   // Red
                    'rgba(127, 29, 29, 0.8)'    // Dark Red
                ],
                borderColor: [
                    'rgba(251, 191, 36, 1)',
                    'rgba(249, 115, 22, 1)',
                    'rgba(239, 68, 68, 1)',
                    'rgba(127, 29, 29, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff',
                        stepSize: 1
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });

    // Overdue Timeline Chart
    const overdueTimelineCtx = document.getElementById('overdueTimelineChart').getContext('2d');
    new Chart(overdueTimelineCtx, {
        type: 'line',
        data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [{
                label: 'New Overdue',
                data: [3, 7, 5, {{ overdue_loans|length }}],
                borderColor: 'rgba(239, 68, 68, 1)',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff',
                        stepSize: 1
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
    {% endif %}

    {% if report_type == 'fines' %}
    // Fine Collection Status Chart
    const fineStatusCtx = document.getElementById('fineStatusChart').getContext('2d');
    new Chart(fineStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Collected', 'Outstanding'],
            datasets: [{
                data: [{{ fine_stats.paid_fines|default:150 }}, {{ fine_stats.unpaid_fines|default:50 }}],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',   // Green for Collected
                    'rgba(239, 68, 68, 0.8)'    // Red for Outstanding
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#ffffff',
                        padding: 20
                    }
                }
            }
        }
    });

    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart').getContext('2d');
    new Chart(revenueCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
            datasets: [{
                label: 'Revenue (MVR)',
                data: [45, 60, 35, 80, 55, 70, 50, 85],
                borderColor: 'rgba(34, 197, 94, 1)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#ffffff',
                        callback: function(value) {
                            return value + ' MVR';
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#ffffff'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            }
        }
    });
    {% endif %}

    function exportReport(format) {
        const urlParams = new URLSearchParams(window.location.search);
        urlParams.set('format', format);
        
        const exportUrl = `{% url 'library:generate_report' %}?${urlParams.toString()}`;
        window.open(exportUrl, '_blank');
    }

    // Print functionality
    function printReport() {
        window.print();
    }

    // Animate progress bars on load
    document.addEventListener('DOMContentLoaded', function() {
        const progressBars = document.querySelectorAll('.progress-animated');
        progressBars.forEach(bar => {
            setTimeout(() => {
                bar.style.width = bar.style.getPropertyValue('--progress-width') || '0%';
            }, 500);
        });
    });
</script>
{% endblock %}
