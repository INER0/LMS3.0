{% extends 'base.html' %}

{% block title %}Edit Book Copy - Library Management System{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-white mb-0">
            <i class="fas fa-edit me-2"></i>Edit Book Copy
        </h1>
        <p class="text-white-50 mb-0">Edit copy: <strong>{{ object.barcode }}</strong> for {{ book.title }}</p>
    </div>
    <div>
        <a href="{% url 'library:manage_book_copies' book.id %}" class="btn btn-glass">
            <i class="fas fa-arrow-left me-1"></i>Back to Copies
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-4">
        <!-- Book Information Card -->
        <div class="glass-card p-4 mb-4">
            <h5 class="text-white mb-3">
                <i class="fas fa-book me-2"></i>Book Details
            </h5>
            
            <div class="mb-2">
                <strong class="text-white-50">Title:</strong>
                <p class="text-white mb-1">{{ book.title }}</p>
            </div>
            
            <div class="mb-2">
                <strong class="text-white-50">ISBN:</strong>
                <p class="text-white mb-1">{{ book.isbn }}</p>
            </div>
            
            <div class="mb-2">
                <strong class="text-white-50">Authors:</strong>
                <p class="text-white mb-1">
                    {% for author in book.authors.all %}
                        {{ author.name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                        No authors
                    {% endfor %}
                </p>
            </div>
            
            <div class="mb-2">
                <strong class="text-white-50">Current Barcode:</strong>
                <p class="text-white mb-0">
                    <span class="badge bg-info">{{ object.barcode }}</span>
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <form method="post">
                {% csrf_token %}
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="id_barcode" class="form-label text-white">Barcode *</label>
                        <input type="text" 
                               class="form-control" 
                               name="barcode" 
                               id="id_barcode"
                               value="{{ object.barcode }}"
                               required>
                        <small class="text-white-50">Unique barcode for this copy</small>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="id_purchase_price" class="form-label text-white">Purchase Price *</label>
                        <input type="number" 
                               class="form-control" 
                               name="purchase_price" 
                               id="id_purchase_price"
                               step="0.01"
                               min="0"
                               value="{{ object.purchase_price }}"
                               required>
                        <small class="text-white-50">Price in your local currency</small>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="id_branch" class="form-label text-white">Branch *</label>
                        <select class="form-select" name="branch" id="id_branch" required>
                            <option value="">Select branch</option>
                            {% for branch in form.branch.field.queryset %}
                                <option value="{{ branch.id }}" {% if branch.id == object.branch.id %}selected{% endif %}>
                                    {{ branch.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="id_section" class="form-label text-white">Section *</label>
                        <select class="form-select" name="section" id="id_section" required>
                            <option value="">Select section</option>
                            {% for section in form.section.field.queryset %}
                                <option value="{{ section.id }}" 
                                        data-branch="{{ section.branch.id }}"
                                        {% if section.id == object.section.id %}selected{% endif %}>
                                    {{ section.name }} ({{ section.branch.name }})
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="id_condition" class="form-label text-white">Condition *</label>
                        <select class="form-select" name="condition" id="id_condition" required>
                            <option value="">Select condition</option>
                            <option value="good" {% if object.condition == 'good' %}selected{% endif %}>Good</option>
                            <option value="damaged" {% if object.condition == 'damaged' %}selected{% endif %}>Damaged</option>
                            <option value="lost" {% if object.condition == 'lost' %}selected{% endif %}>Lost</option>
                        </select>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="id_last_seen" class="form-label text-white">Last Seen Date</label>
                        <input type="date" 
                               class="form-control" 
                               name="last_seen" 
                               id="id_last_seen"
                               value="{{ object.last_seen|date:'Y-m-d' }}">
                        <small class="text-white-50">Date when this copy was last verified</small>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 mt-4">
                    <a href="{% url 'library:manage_book_copies' book.id %}" class="btn btn-secondary">
                        <i class="fas fa-times me-1"></i>Cancel
                    </a>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-1"></i>Update Copy
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Filter sections based on selected branch
    document.getElementById('id_branch').addEventListener('change', function() {
        const selectedBranch = this.value;
        const sectionSelect = document.getElementById('id_section');
        const options = sectionSelect.querySelectorAll('option');
        
        options.forEach(option => {
            if (option.value === '') {
                option.style.display = 'block';
            } else {
                const branchId = option.getAttribute('data-branch');
                if (branchId === selectedBranch) {
                    option.style.display = 'block';
                } else {
                    option.style.display = 'none';
                }
            }
        });
        
        // Reset section selection if current selection is not valid for new branch
        const currentSection = sectionSelect.value;
        if (currentSection) {
            const currentOption = sectionSelect.querySelector(`option[value="${currentSection}"]`);
            if (currentOption && currentOption.getAttribute('data-branch') !== selectedBranch) {
                sectionSelect.value = '';
            }
        }
    });

    // Form validation
    document.querySelector('form').addEventListener('submit', function(e) {
        const barcode = document.getElementById('id_barcode').value.trim();
        const price = parseFloat(document.getElementById('id_purchase_price').value);
        
        if (!barcode) {
            e.preventDefault();
            alert('Please enter a barcode');
            document.getElementById('id_barcode').focus();
            return;
        }
        
        if (barcode.length < 3) {
            e.preventDefault();
            alert('Barcode should be at least 3 characters long');
            document.getElementById('id_barcode').focus();
            return;
        }
        
        if (isNaN(price) || price < 0) {
            e.preventDefault();
            alert('Please enter a valid purchase price');
            document.getElementById('id_purchase_price').focus();
            return;
        }
    });
</script>
{% endblock %}
