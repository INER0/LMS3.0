{% extends 'base.html' %}

{% block title %}Manage Book Copies - Library Management System{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="text-white mb-0">
            <i class="fas fa-copy me-2"></i>Manage Book Copies
        </h1>
        <p class="text-white-50 mb-0">{{ book.title }} - ISBN: {{ book.isbn }}</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{% url 'library:add_book_copy' book.id %}" class="btn btn-success">
            <i class="fas fa-plus me-1"></i>Add New Copy
        </a>
        <a href="{% url 'library:manage_books' %}" class="btn btn-glass">
            <i class="fas fa-arrow-left me-1"></i>Back to Books
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-lg-3">
        <!-- Book Summary Card -->
        <div class="glass-card p-4 mb-4">
            <h5 class="text-white mb-3">
                <i class="fas fa-book me-2"></i>Book Summary
            </h5>
            
            <div class="mb-3">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h2 text-success mb-0">{{ total_copies }}</div>
                            <small class="text-white-50">Total Copies</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h2 text-info mb-0">{{ available_copies }}</div>
                            <small class="text-white-50">Available</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h2 text-warning mb-0">{{ borrowed_copies }}</div>
                            <small class="text-white-50">Borrowed</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <div class="h2 text-secondary mb-0">{{ other_copies }}</div>
                            <small class="text-white-50">Other Status</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Book Details -->
            <div class="border-top border-secondary pt-3 mt-3">
                <div class="mb-2">
                    <strong class="text-white-50">Authors:</strong>
                    <p class="text-white mb-1 small">
                        {% for author in book.authors.all %}
                            {{ author.name }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                            No authors
                        {% endfor %}
                    </p>
                </div>
                
                <div class="mb-2">
                    <strong class="text-white-50">Publisher:</strong>
                    <p class="text-white mb-1 small">{{ book.publisher.name }}</p>
                </div>
                
                <div class="mb-0">
                    <strong class="text-white-50">Category:</strong>
                    <p class="text-white mb-0 small">{{ book.get_category_display }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-9">
        <!-- Filters and Search -->
        <div class="glass-card p-3 mb-4">
            <div class="row g-3 align-items-end">
                                <div class="col-md-3">
                    <label class="form-label text-white-50 small">Search</label>
                    <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Barcode, ID...">
                </div>
                <div class="col-md-3">
                    <label class="form-label text-white-50 small">Condition</label>
                    <select class="form-select form-select-sm" id="conditionFilter">
                        <option value="">All Conditions</option>
                        <option value="good">Good</option>
                        <option value="damaged">Damaged</option>
                        <option value="lost">Lost</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label text-white-50 small">Branch</label>
                    <select class="form-select form-select-sm" id="branchFilter">
                        <option value="">All Branches</option>
                        {% for branch in branches %}
                            <option value="{{ branch.id }}">{{ branch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="d-flex gap-1">
                        <button type="button" class="btn btn-outline-light btn-sm" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="exportCopies()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Book Copies Table -->
        <div class="glass-card">
            <div class="table-responsive">
                <table class="table table-dark table-hover mb-0" id="copiesTable">
                    <thead class="table-dark">
                        <tr>
                            <th>Barcode</th>
                            <th>Status</th>
                            <th>Condition</th>
                            <th>Location</th>
                            <th>Last Seen</th>
                            <th>Current Borrower</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for copy in book_copies %}
                        <tr data-condition="{{ copy.condition }}" 
                            data-branch="{{ copy.branch.id }}"
                            data-search="{{ copy.barcode|lower }}">
                            <td>
                                <strong>{{ copy.barcode }}</strong>
                                <br><small class="text-white-50">ID: {{ copy.id }}</small>
                            </td>
                            <td>
                                {% if copy.is_available %}
                                    <span class="badge bg-success">Available</span>
                                {% else %}
                                    <span class="badge bg-warning">Borrowed</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if copy.condition == 'good' %}
                                    <i class="fas fa-star text-success"></i> Good
                                {% elif copy.condition == 'damaged' %}
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Damaged
                                {% elif copy.condition == 'lost' %}
                                    <i class="fas fa-times text-danger"></i> Lost
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ copy.section.name }}</strong>
                                <br><small class="text-white-50">{{ copy.branch.name }}</small>
                            </td>
                            <td>{{ copy.last_seen|date:"M d, Y" }}</td>
                            <td>
                                {% if not copy.is_available %}
                                    {% for loan in copy.bookloan_set.all %}
                                        {% if loan.status == 'borrowed' %}
                                            <strong>{{ loan.user.get_full_name }}</strong>
                                            <br><small class="text-white-50">Due: {{ loan.due_date|date:"M d" }}</small>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                            onclick="viewCopy({{ copy.id }})" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{% url 'library:edit_book_copy' copy.id %}" 
                                       class="btn btn-outline-warning btn-sm" title="Edit Copy">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if copy.is_available %}
                                    <button type="button" class="btn btn-outline-success btn-sm" 
                                            onclick="lendCopy({{ copy.id }})" title="Lend Copy">
                                        <i class="fas fa-hand-holding"></i>
                                    </button>
                                    {% endif %}
                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                            onclick="deleteCopy({{ copy.id }})" title="Delete Copy">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <i class="fas fa-box-open text-white-50 display-1 mb-3"></i>
                                <p class="text-white-50">No copies found for this book.</p>
                                <a href="{% url 'library:add_book_copy' book.id %}" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i>Add First Copy
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Filter functionality
    function filterTable() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const conditionFilter = document.getElementById('conditionFilter').value;
        const branchFilter = document.getElementById('branchFilter').value;
        
        const rows = document.querySelectorAll('#copiesTable tbody tr[data-condition]');
        
        rows.forEach(row => {
            const condition = row.getAttribute('data-condition');
            const branch = row.getAttribute('data-branch');
            const searchText = row.getAttribute('data-search');
            
            let show = true;
            
            // Search filter
            if (searchTerm && !searchText.includes(searchTerm)) {
                show = false;
            }
            
            // Condition filter
            if (conditionFilter && condition !== conditionFilter) {
                show = false;
            }
            
            // Branch filter
            if (branchFilter && branch !== branchFilter) {
                show = false;
            }
            
            row.style.display = show ? '' : 'none';
        });
    }
    
    // Event listeners for filters
    document.getElementById('searchInput').addEventListener('input', filterTable);
    document.getElementById('conditionFilter').addEventListener('change', filterTable);
    document.getElementById('branchFilter').addEventListener('change', filterTable);
    
    function clearFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('conditionFilter').value = '';
        document.getElementById('branchFilter').value = '';
        filterTable();
    }
    
    function viewCopy(copyId) {
        // Open copy details in modal or navigate to detail page
        alert('View copy details for copy ID: ' + copyId);
        // TODO: Implement copy details view
    }
    
    function lendCopy(copyId) {
        // Navigate to lending page
        window.location.href = `/circulation/lend/${copyId}/`;
    }
    
    function deleteCopy(copyId) {
        if (confirm('Are you sure you want to delete this copy? This action cannot be undone.')) {
            // TODO: Implement copy deletion
            alert('Delete copy functionality to be implemented');
        }
    }
    
    function exportCopies() {
        // Export copies to CSV or PDF
        alert('Export functionality to be implemented');
    }
</script>
{% endblock %}
